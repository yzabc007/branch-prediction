/////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////
//                                                                             //
// This file is distributed as part of the Championship Branch Prediction      //
// workshop held in conjunction with ISCA'2014.                                //
// Everyone is granted permission to copy, modify, and/or re-distribute        //
// this software.                                                              //
// Please contact Moinuddin Qureshi <moin@gatech.edu> if you have any questions//
//                                                                             //
/////////////////////////////////////////////////////////////////////////////////

// --- DO NOT EDIT THIS FILE --- DO NOT EDIT THIS FILE --- DO NOT EDIT THIS FILE ---
// IMPORTANT NOTE: Changing anything in here will violate the competition rules.



#include "utils.h"
#include "tracer.h"
#include "predictor.h"


// usage: predictor <trace>

int main(int argc, char* argv[]){
  
  if (argc != 2) {
    printf("usage: %s <trace>\n", argv[0]);
    exit(-1);
  }
  
  ///////////////////////////////////////////////
  // Init variables
  ///////////////////////////////////////////////
    
    CBP_TRACER *tracer = new CBP_TRACER(argv[1]);
    PREDICTOR  *brpred = new PREDICTOR();
    CBP_TRACE_RECORD *trace = new CBP_TRACE_RECORD();
    UINT64     numMispred =0;  
    
  ///////////////////////////////////////////////
  // read each trace recod, simulate until done
  ///////////////////////////////////////////////

      while (tracer->GetNextRecord(trace)) {

	if(trace->opType == OPTYPE_BRANCH_COND){

	  bool predDir = brpred->GetPrediction(trace->PC);

	  brpred->UpdatePredictor(trace->PC, trace->branchTaken, 
				  predDir, trace->branchTarget);
	  
	  if(predDir != trace->branchTaken){
	    numMispred++; // update mispred stats
	  }
	  
	}
        // for predictors that want to track all insts
	else{
	  brpred->TrackOtherInst(trace->PC, trace->opType, trace->branchTarget);
	}
      
      }

    ///////////////////////////////////////////
    //print_stats
    ///////////////////////////////////////////

      printf("\n");
      printf("\nNUM_INSTRUCTIONS     \t : %10llu",   tracer->GetNumInst());
      printf("\nNUM_CONDITIONAL_BR   \t : %10llu",   tracer->GetNumCondBranch());
      printf("\nNUM_MISPREDICTIONS   \t : %10llu",   numMispred);
      printf("\nMISPRED_PER_1K_INST  \t : %10.3f",   1000.0*(double)(numMispred)/(double)(tracer->GetNumInst()));
      printf("\n\n");
}



